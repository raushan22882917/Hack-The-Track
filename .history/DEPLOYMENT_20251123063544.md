# Deployment Guide for Telemetry Rush

## Overview

This guide explains how to deploy the Telemetry Rush application and configure it properly to avoid connection issues.

## The Problem

When you deploy the application, the frontend will try to connect to `localhost:8000` by default, which won't work because:

1. **`localhost` in the browser refers to the user's machine**, not your server
2. The frontend and backend are typically on different hosts/domains in production
3. WebSocket connections need the correct backend URL

## Solution: Environment Variables

The frontend uses environment variables to configure the backend URL. You **must** set these when deploying.

### Required Environment Variables

Create a `.env` file in the `react-frontend/` directory (or configure them in your deployment platform):

```bash
# Backend API Base URL - CRITICAL for deployment
VITE_API_BASE_URL=https://your-backend-domain.com

# Or if using HTTP:
# VITE_API_BASE_URL=http://your-backend-ip:8000

# WebSocket settings (optional, defaults shown)
VITE_WEBSOCKET_ENABLED=true
VITE_WEBSOCKET_AUTO_CONNECT=true
```

### Important Notes

1. **No trailing slash**: The URL should NOT end with `/` (e.g., `https://api.example.com` not `https://api.example.com/`)
2. **Protocol matters**: Use `https://` for production, `http://` only for local development
3. **WebSocket protocol**: The code automatically converts `http://` to `ws://` and `https://` to `wss://`

## Deployment Steps

### 1. Backend Deployment (FastAPI)

Deploy your FastAPI server to your hosting platform (e.g., Render, Railway, Heroku, AWS, etc.)

**Important**: Make sure:
- The server listens on `0.0.0.0` (not just `localhost`) - this is already configured in `main.py`
- Port is configured via `PORT` environment variable (defaults to 8000)
- CSV files are available in `fastapi-server/logs/vehicles/` directory
- CORS is enabled (already configured in `main.py`)

### 2. Frontend Deployment (React/Vite)

#### Option A: Using Vite Build (Static Hosting)

1. **Set environment variables** before building:
   ```bash
   cd react-frontend
   # Create .env file with your backend URL
   echo "VITE_API_BASE_URL=https://your-backend-domain.com" > .env
   ```

2. **Build the frontend**:
   ```bash
   npm run build
   ```

3. **Deploy the `dist/` folder** to your static hosting (Vercel, Netlify, GitHub Pages, etc.)

#### Option B: Using Environment Variables in Deployment Platform

Most platforms allow you to set environment variables:

**Vercel:**
- Go to Project Settings → Environment Variables
- Add `VITE_API_BASE_URL` with your backend URL

**Netlify:**
- Go to Site Settings → Environment Variables
- Add `VITE_API_BASE_URL` with your backend URL

**Render:**
- Go to Environment tab
- Add `VITE_API_BASE_URL` with your backend URL

**Note**: Vite requires the `VITE_` prefix for environment variables to be exposed to the client.

### 3. Verify Deployment

1. **Check browser console** for connection errors
2. **Verify the API URL** is correct (check Network tab in DevTools)
3. **Test WebSocket connection** (should connect to `wss://your-backend.com/ws/telemetry`)

## Common Issues

### Issue: "Connecting to server..." message persists

**Causes:**
- Backend URL not configured (still using `localhost:8000`)
- Backend server not running
- CORS issues (should be handled by backend, but check)
- Firewall blocking connections

**Solution:**
1. Check browser console for errors
2. Verify `VITE_API_BASE_URL` is set correctly
3. Test backend health endpoint: `https://your-backend.com/api/health`
4. Check WebSocket connection in Network tab

### Issue: WebSocket connection fails

**Causes:**
- Wrong protocol (using `ws://` over HTTPS - should use `wss://`)
- Backend not configured for WebSocket
- Proxy/load balancer not configured for WebSocket upgrade

**Solution:**
- Ensure backend URL uses `https://` (automatically converts to `wss://`)
- Check that your reverse proxy (nginx, etc.) supports WebSocket upgrades
- Verify backend WebSocket endpoints are accessible

### Issue: CORS errors

**Causes:**
- Backend CORS not configured for your frontend domain
- Missing credentials/headers

**Solution:**
- Update backend CORS configuration in `main.py` to include your frontend domain
- Currently set to `allow_origins=["*"]` which should work, but you may want to restrict it

## Example Deployment Configurations

### Render.com

**Backend (FastAPI):**
```yaml
# render.yaml
services:
  - type: web
    name: telemetry-backend
    env: python
    buildCommand: pip install -r requirements.txt
    startCommand: python -m uvicorn main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: PORT
        value: 8000
```

**Frontend (React):**
- Build Command: `cd react-frontend && npm install && npm run build`
- Publish Directory: `react-frontend/dist`
- Environment Variables:
  - `VITE_API_BASE_URL`: `https://telemetry-backend.onrender.com`

### Vercel

**Frontend:**
- Framework Preset: Vite
- Root Directory: `react-frontend`
- Environment Variables:
  - `VITE_API_BASE_URL`: Your backend URL

## Testing Locally Before Deployment

1. **Test with production-like URL**:
   ```bash
   # In react-frontend/.env
   VITE_API_BASE_URL=http://localhost:8000
   ```

2. **Start backend**:
   ```bash
   cd fastapi-server
   python run.py
   ```

3. **Start frontend**:
   ```bash
   cd react-frontend
   npm run dev
   ```

4. **Verify connection** in browser console

## Summary

**The key issue**: The frontend defaults to `localhost:8000`, which doesn't work in production.

**The solution**: Set `VITE_API_BASE_URL` environment variable to your actual backend URL before building/deploying.

**Remember**: 
- ✅ Set `VITE_API_BASE_URL` for deployment
- ✅ Use `https://` for production (auto-converts to `wss://` for WebSocket)
- ✅ No trailing slash in the URL
- ✅ Rebuild frontend after changing environment variables

